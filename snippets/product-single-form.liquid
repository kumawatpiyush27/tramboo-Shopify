{%- assign has_compare_btn = false -%}
{%- assign has_wishlist_btn = false -%}
{%- if block.settings.show_compare_btn and settings.enable_compare -%}
  {%- assign has_compare_btn = true -%}
{%- endif -%}
{%- if block.settings.show_wishlist_btn and settings.enable_wishlist -%}
  {%- assign has_wishlist_btn = true -%}
{%- endif -%}
<div class="w100" {{ block.shopify_attributes }}>
  {%- render 'product-single-customizable-fields' -%}
  <div class="product-form__item product-form__item--quantity{% if align_center_button %} center-block text-center{% endif %} gutter-ele-top gutter-ele-bottom flex">
    {%- if block.settings.show_quantity_selector -%}
    <div class="qty-box qty-box--single flex flex-align-ver flex-align-space-between{% if full_qty_box %} qty-box--single-full{% endif %}">
      <a href="#" class="qty-box__ctrl qty-box__ctrl--descrease flex flex-align-hoz flex-align-ver" aria-label="button">
        {%- render 'icon-minus' -%}
      </a>
      <input type="number" name="quantity" value="1" min="1" class="qty-box__input w100{% if template.suffix != 'quick_view' %} qty-box__input--sync{% endif %} text-center h100 qty-box__input--single" aria-label="form" style="font-size:20px;">
      <a href="#" class="qty-box__ctrl qty-box__ctrl--increase flex flex-align-hoz flex-align-ver" aria-label="button">
        {%- render 'icon-plus' -%}
      </a>
    </div>
    {%- endif -%}
    {%- if current_variant.available -%}
      {%- unless settings.pre_order_enable and product.first_available_variant.inventory_policy == 'continue' and product.first_available_variant.inventory_quantity <= 0 -%}
        {%- assign cart_text = 'products.product.add_to_cart' | t -%}
      {%- else -%}
        {%- assign cart_text = 'products.product.pre_order' | t -%}
      {%- endunless -%}
    {%- else -%}
      {%- assign cart_text = 'products.product.sold_out' | t -%}  
    {%- endif -%}  
    <button class="button button--rad button--one-line add-cart-btn button--single-cart button--cart button--border-transparent flex flex-align-ver flex-align-hoz add-cart-btn--state por{% if template.suffix != 'quick_view' %} button--single-cart-main{% endif %}" type="submit" name="add" title="{{ cart_text | escape }}" aria-label="button" style="height:45px;flex-grow:1;"{% unless current_variant.available %} disabled="disabled"{% endunless %}>
      {%- render 'icon-cart' with add_class: 'button__icon' -%}
      <span{% if section.settings.enable_cart_animation %} class="ring-little"{% endif %}>{{ cart_text }}</span>
    </button>
    {%- if has_wishlist_btn -%}
      <a title="{{ 'collections.product_item.add_to_wishlist' | t | escape }}" data-id="{{ product.id }}" href="#" class="button--wl button--wl-text button--wl-single button--single-inline flex flex-align-ver flex-align-hoz transition hidden-xs" data-toggle="tooltip" data-placement="top" data-product-title="{{ product.title | escape }}">
        {% render 'icon-wishlist' %}
      </a>
    {%- endif -%}
    {%- if has_compare_btn -%}
      <a title="{{ 'collections.product_item.add_to_compare' | t | escape }}" data-id="{{ product.id }}" href="#" class="button--cp button--cp-single button--single-inline flex flex-align-ver flex-align-hoz transition hidden-xs" data-toggle="tooltip" data-placement="top" data-product-title="{{ product.title | escape }}">
        {%- render 'icon-compare' -%}
      </a>
    {%- endif -%}
  </div>
  {%- if template.suffix != 'quick_view' and template.suffix != 'select_option' -%}
    {% if block.settings.show_dynamic_checkout %}
    <div class="shopify-payment-btn-wrap w100">
      <div id="shopify_buy_now" style="display:none;">
                    {{ form | payment_button }}
                   </div>
                  <div id="block_buy_now" style="display:none;">
                      {% render 'gokwik-buy-now' %}
                      </div>
    </div>
    {% endif %} 
  {%- endif -%}
  {%- if template.suffix != 'quick_view' and template.suffix != 'select_option' -%}
    <!-- Customize Button Start -->
    <div class="customize-card">
      <div class="customize-card__info">
        <div class="customize-card__title">Make Your Product Personalised</div>
        <div class="customize-card__desc">Get A Customized Engraving And Make It Unmistakably Yours.</div>
        <button id="customize-product-btn" type="button" class="customize-card__btn">
          <span>Customize</span>
        </button>
      </div>
      <div class="customize-card__icon">
        <!-- Simple Engraving Icon SVG -->
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="8" y="8" width="24" height="24" rx="6" stroke="#222" stroke-width="2" fill="none"/>
          <rect x="16" y="24" width="8" height="2" rx="1" fill="#222"/>
          <path d="M28 16l-6 6" stroke="#222" stroke-width="2" stroke-linecap="round"/>
          <rect x="25.5" y="13.5" width="5" height="2" rx="1" transform="rotate(45 25.5 13.5)" fill="#222"/>
        </svg>
      </div>
    </div>
    <style>
      .customize-card {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #f7f8fa;
        border-radius: 12px;
        padding: 24px 28px;
        margin: 18px 0 0 0;
        box-shadow: 0 1px 2px rgba(0,0,0,0.03);
      }
      .customize-card__info {
        flex: 1;
      }
      .customize-card__title {
        font-size: 1.15rem;
        font-weight: 700;
        margin-bottom: 6px;
        color: #111;
      }
      .customize-card__desc {
        color: #2264d1;
        font-size: 1rem;
        margin-bottom: 14px;
      }
      .customize-card__btn {
        background: #1e90ff;
        color: #fff;
        padding: 10px 28px;
        font-size: 1rem;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
      }
      .customize-card__btn:hover {
        background: #156fcc;
      }
      .customize-card__icon {
        margin-left: 28px;
        display: flex;
        align-items: center;
      }
      @media (max-width: 600px) {
        .customize-card {
          flex-direction: column;
          align-items: flex-start;
          padding: 16px;
        }
        .customize-card__icon {
          margin-left: 0;
          margin-top: 16px;
        }
      }
    </style>
      </button>
    </div>
    <!-- Customize Modal Popup -->
    <div id="customize-modal" class="customize-modal" style="display:none;position:fixed;z-index:9999;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);align-items:center;justify-content:center;">
      <div class="customize-modal-content" style="background:#fff;padding:32px 24px 24px 24px;border-radius:12px;max-width:90vw;width:380px;position:relative;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.18);">
        <button id="close-customize-modal" style="position:absolute;top:8px;right:8px;background:none;border:none;font-size:28px;cursor:pointer;">&times;</button>
        <div style="margin-bottom:12px;">
          <div style="position:relative;display:inline-block;">
            <img id="customize-product-image" src="{{ product.featured_image | img_url: '400x' }}" alt="{{ product.title }}" style="width:140px;height:140px;object-fit:contain;">
            <span id="engraving-preview" style="position:absolute;left:0;right:0;bottom:20px;font-size:20px;font-weight:600;color:#222;letter-spacing:1px;text-shadow:0 1px 3px #fff;text-align:center;width:100%;pointer-events:none;">&nbsp;</span>
          </div>
        </div>
        <h2 style="margin-bottom:2px; font-size:22px; font-weight:700;">Personalize Your {{ product.title }}</h2>
        <div style="margin-bottom:4px; color:#888;font-size:14px;">At just â‚¹<span id="customization-price">{{ current_variant.price | divided_by: 100 | plus: 50 }}</span></div>
        <form id="customize-form" style="margin-top:16px;">
          <input type="text" id="engraving-name" name="properties[Engraving Name]" maxlength="12" autocomplete="off" placeholder="Your Engraving Name" style="width:100%;padding:12px 10px;font-size:16px;border-radius:6px;border:1px solid #ccc;text-align:center;margin-bottom:6px;">
          <div style="color:#888;font-size:12px;margin-bottom:10px;">Limit text to alphabets, numbers, no emojis or special characters. Max 12 characters allowed.</div>
          <button id="buy-now-custom" type="button" style="display:none;width:100%;background:#111;color:#fff;padding:12px 0;font-size:16px;font-weight:600;border:none;border-radius:4px;cursor:pointer;margin-bottom:8px;">Buy Now</button>
        </form>
        <a href="#" id="skip-customization" style="display:block;color:#1e90ff;font-size:14px;text-decoration:underline;margin-top:8px;">Skip Personalization</a>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var customizeBtn = document.getElementById('customize-product-btn');
        var modal = document.getElementById('customize-modal');
        var closeBtn = document.getElementById('close-customize-modal');
        var engravingInput = document.getElementById('engraving-name');
        var engravingPreview = document.getElementById('engraving-preview');
        var buyNowBtn = document.getElementById('buy-now-custom');
        var skipBtn = document.getElementById('skip-customization');
        var customizationPrice = document.getElementById('customization-price');
        var basePrice = parseInt({{ current_variant.price | divided_by: 100 }});
        var customCharge = 50;
        // Open modal
        if (customizeBtn && modal && closeBtn) {
          customizeBtn.addEventListener('click', function() {
            modal.style.display = 'flex';
          });
          closeBtn.addEventListener('click', function() {
            modal.style.display = 'none';
            resetPopup();
          });
          modal.addEventListener('click', function(event) {
            if (event.target === modal) {
              modal.style.display = 'n ne';
              resetPopup();
            }
          });
        }
        // Skip personalization
        if (skipBtn) {
          skipBtn.addEventListener('click', function(e) {
            e.preventDefault();
            modal.style.display = 'none';
            resetPopup();
          });
        }
        // Input validation
        function isValidName(name) {
          return /^[A-Za-z0-9 ]{1,12}$/.test(name);
        }
        function updatePreview() {
          var val = engravingInput.value;
          if (isValidName(val)) {
            engravingPreview.textContent = val;
            buyNowBtn.style.display = 'block';
          } else {
            engravingPreview.textContent = '';
            buyNowBtn.style.display = 'none';
          }
        }
        if (engravingInput && engravingPreview && buyNowBtn) {
          engravingInput.addEventListener('input', updatePreview);
        }
        // Buy Now button action
       
   
  {%- endif -%}

  {%- if has_compare_btn or has_wishlist_btn -%}
  <div class="gutter-ele-top gutter-ele-bottom hidden-sm hidden-md hidden-lg">
    {%- if has_compare_btn -%}
    <a title="{{ 'collections.product_item.add_to_compare' | t | escape }}" data-id="{{ product.handle }}" href="#" class="button--cp button--cp-single dib{% if full_qty_box %} w100{% endif %}" data-product-title="{{ product.title | escape }}">
      {%- unless enable_rtl -%}
        {% render 'icon-compare' %}&nbsp;{{ 'collections.product_item.add_to_compare' | t }}
      {%- else -%}
        {{ 'collections.product_item.add_to_compare' | t }}&nbsp;{%- render 'icon-compare' -%} 
      {%- endunless -%}
    </a>
    {%- endif -%}
    {%- if has_wishlist_btn -%}
    <a title="{{ 'collections.product_item.add_to_wishlist' | t | escape }}" data-id="{{ product.id }}" href="#" class="button--wl button--wl-text button--wl-single dib {% if full_qty_box %}w100 distance-top-ele{% else %}{% if block.settings.show_compare_btn and settings.enable_compare %}button--wl-single-distance {% endif %}gutter-ele-top-tbs{% endif %}" data-product-title="{{ product.title | escape }}">
      {%- unless enable_rtl -%}
        {% render 'icon-wishlist' %}&nbsp;<span class="wishlist-text">{{ 'collections.product_item.add_to_wishlist' | t }}</span>
      {%- else -%}
        <span class="wishlist-text">{{ 'collections.product_item.add_to_wishlist' | t }}</span>&nbsp;{%- render 'icon-wishlist' -%}
      {%- endunless -%}
    </a>
    {%- endif -%}
  </div>
  {%- endif -%}

  {%- if template.suffix != 'quick_view' and template.suffix != 'select_option' and block.settings.enable_shop_pay_banner -%}
  <div class="gutter-ele-top gutter-ele-bottom">
    {{ form | payment_terms }}
  </div>
  {%- endif -%}
  <input type="hidden" name="id" class="variant-id" value="{{ product.selected_or_first_available_variant.id }}" />